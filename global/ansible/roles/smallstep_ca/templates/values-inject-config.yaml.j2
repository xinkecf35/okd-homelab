# Helm template
inject:
  enabled: true
  # Config contains the configuration files ca.json and defaults.json
  config:
    files:
      ca.json:
        root: /home/step/certs/root_ca.crt
        federateRoots: []
        crt: /home/step/certs/intermediate_ca.crt
        key: /home/step/secrets/intermediate_ca_key
        address: :9000
        dnsNames:
{% for san in smallstep_ca_sans %}
          - {{ san }}
{% endfor %}
        logger:
          format: json
        db:
          type: badgerv2
          dataSource: /home/step/db
        authority:
          enableAdmin: false
          provisioners:
{% for provisioner in smallstep_ca_provisioners %}
          - {{ provisioner }}
{% endfor %}
        tls:
          cipherSuites:
            - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256
            - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
          minVersion: 1.2
          maxVersion: 1.3
          renegotiation: false

      defaults.json:
        ca-url: https://{{ smallstep_ca_cn }}
        ca-config: /home/step/config/ca.json
        fingerprint: {{ smallstep_ca_root_ca_fingerprint }}
        root: /home/step/certs/root_ca.crt

  # Certificates contains the root and intermediate certificate and 
  # optionally the SSH host and user public keys
  certificates:
    # intermediate_ca contains the text of the intermediate CA Certificate
    intermediate_ca: |
{{ smallstep_ca_intermediate_ca_cert | indent(6,true) }}
    # root_ca contains the text of the root CA Certificate
    root_ca: |
{{ smallstep_ca_root_ca_cert | indent(6, true) }}
      

  # Secrets contains the root and intermediate keys and optionally the SSH
  # private keys
  secrets:
    # ca_password contains the password used to encrypt x509.intermediate_ca_key, ssh.host_ca_key and ssh.user_ca_key
    # This value must be base64 encoded.
    ca_password: {{ smallstep_ca_intermediate_ca_password | b64encode }}
    provisioner_password: {{ smallstep_ca_provisioner_password | b64encode }}

    x509:
      # intermediate_ca_key contains the contents of your encrypted intermediate CA key
      intermediate_ca_key: |
{{ smallstep_ca_intermediate_ca_key | indent(8, true) }}

ingress:
  annotations:
    route.openshift.io/termination: passthrough
  enabled: true
  ingressClassName: openshift-default
  hosts:
    - host: {{ smallstep_ca_cn }}
      paths: 
        - path: ''
          type: ImplementationSpecific

serviceaccount:
  create: true
  name: {{ smallstep_ca_service_account_name }}

ca:
# Adjust SecurityContexts to play nice with OKD
  init:
    containerSecurityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop: ["ALL"]
      runAsNonRoot: true
      seccompProfile:
        type: RuntimeDefault
  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop: ["ALL"]
      add: ["NET_BIND_SERVICE"]
    runAsNonRoot: true
    fsGroup: 1004
    fsGroupChangePolicy: OnRootMismatch
  db:
    storageClass: nfs
    accessModes:
    - ReadWriteMany

# Adjust SecurityContexts to play nice with OKD
bootstrap:
  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop: ["ALL"]
    runAsNonRoot: true

podSecurityContext:
  runAsNonRoot: true
  fsGroup: 1004
  fsGroupChangePolicy: OnRootMismatch
  seccompProfile:
    type: RuntimeDefault